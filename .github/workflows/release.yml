# .github/workflows/release.yml
# Автоматический релиз: вычисление версии -> тег -> сборка WPF на Windows -> компиляция Inno Setup -> загрузка инсталлятора в релиз
# Убедитесь, что проект WPF находится в папке parmigiano-desktop и файл проекта называется корректно.
# Настройки путей можно править под структуру вашего репозитория.

name: Release

on:
  push:
    branches: [main]
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  prepare-version:
    name: Prepare version & changelog
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true

      - name: Get next version tag
        id: get-version
        run: |
          set -e
          latest=$(git tag --sort=-v:refname | grep '^v' | head -n 1 || true)
          echo "Последний тег: $latest"

          if [ -z "$latest" ]; then
            version="v0.1.0"
          else
            raw_version=${latest#v}
            major=$(echo "$raw_version" | cut -d. -f1)
            minor=$(echo "$raw_version" | cut -d. -f2)
            patch=$(echo "$raw_version" | cut -d. -f3)

            # простая логика: увеличиваем minor и сбрасываем patch
            minor=$((minor + 1))
            patch=0
            version="v$major.$minor.$patch"
          fi

          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Create tag and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag ${{ steps.get-version.outputs.version }}
          git push origin ${{ steps.get-version.outputs.version }}

      - name: Create GitHub Release (draft)
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get-version.outputs.version }}
          name: "${{ steps.get-version.outputs.version }}"
          body: "Automated release for ${{ steps.get-version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build WPF + Inno and upload installer
    runs-on: windows-latest
    needs: prepare-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x" # при необходимости поменяйте на вашу версию

      - name: Restore NuGet packages
        run: |
          dotnet restore ./parmigiano-desktop/Parmigiano.Desktop.sln || true
        shell: pwsh

      - name: Replace Config.TYPE_RELEASE -> "prod"
        run: |
          $file = 'Core/Config.cs'
          Write-Host "Modifying $file"
          (Get-Content $file) -replace 'TYPE_RELEASE"\)\s*\{\s*get;\s*\}\s*=\s*".*?"', 'TYPE_RELEASE")\s*{ get; } = "prod"' | Set-Content $file
          Get-Content $file | Select-String 'TYPE_RELEASE' -Context 0,2
        shell: pwsh

      - name: Build (publish) WPF Release x64
        run: |
          dotnet publish ./parmigiano-desktop/Parmigiano.Desktop.csproj -c Release -r win-x64 --self-contained false -o ./parmigiano-desktop/bin/Release
        shell: pwsh

      - name: Prepare Inno script (substitute version and paths)
        id: prepare_iss
        run: |
          $tag = '${{ needs.prepare-version.outputs.version }}'
          Write-Host "Using tag: $tag"

          $src = 'installer/ParmigianoInstaller.iss'
          $out = 'installer/ParmigianoInstaller_generated.iss'

          if (!(Test-Path $src)) {
            Write-Error "Inno script not found: $src"
            exit 1
          }

          $text = Get-Content $src -Raw

          $text = [regex]::Replace($text, 'AppVersion\s*=\s*.*', "AppVersion=$tag")

          $outfile = "ParmigianoChatSetup-$tag"
          $text = [regex]::Replace($text, 'OutputBaseFilename\s*=\s*.*', "OutputBaseFilename=$outfile")

          # Заменяем абсолютные пути на относительные внутри репо
          # Пример: SetupIconFile, LicenseFile, Files Source
          $repoRoot = '${{ github.workspace }}'.Replace('\','\\')

          # Icon
          $text = [regex]::Replace($text, 'SetupIconFile=.*', "SetupIconFile=\"$repoRoot\\parmigiano-desktop\\Public\\assets\\logo-x500.ico\"")
          # License
          $text = [regex]::Replace($text, 'LicenseFile=.*', "LicenseFile=\"$repoRoot\\LICENSE\"")

          # Files section: указываем на папку публикации
          $text = [regex]::Replace($text, 'Source:\s*".*\\bin\\Release\\\*"; DestDir: "\{app\}"; Flags:.*', "Source: \"$repoRoot\\parmigiano-desktop\\bin\\Release\\*\"; DestDir: \"{app}\"; Flags: ignoreversion recursesubdirs createallsubdirs")

          Set-Content -Path $out -Value $text -Encoding UTF8
          Write-Host "Generated: $out"
        shell: pwsh

      - name: Install Inno Setup (choco)
        run: |
          choco install innosetup -y
        shell: pwsh

      - name: Compile Inno Setup script
        run: |
          $iss = 'installer/ParmigianoInstaller_generated.iss'
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"

          if (!(Test-Path $iscc)) {
            # try 32-bit program files
            $iscc = "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
          }

          if (!(Test-Path $iscc)) {
            Write-Error "ISCC.exe not found. Inno Setup may not be installed."
            exit 1
          }

          & $iscc $iss

          # Получаем имя сгенерированного файла / папки (OutputDir/OutputBaseFilename)
          # В скрипте OutputDir=SetupOutput
          $setupOut = Join-Path -Path "$PWD" -ChildPath 'installer\SetupOutput'
          Write-Host "Listing $setupOut"
          Get-ChildItem $setupOut -File | ForEach-Object { Write-Host $_.FullName }
        shell: pwsh

      - name: Upload installer to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = '${{ needs.prepare-version.outputs.version }}'
          $repo = '${{ github.repository }}'
          $token = '${{ secrets.GITHUB_TOKEN }}'

          # Найдём релиз по тегу
          $release = Invoke-RestMethod -Headers @{Authorization = "token $token"} -Uri "https://api.github.com/repos/$repo/releases/tags/$tag"
          $upload_url = $release.upload_url -replace '\{\?name,label\}',''

          # Найдём файл .exe в SetupOutput
          $setupOut = Join-Path -Path "$PWD" -ChildPath 'installer\SetupOutput'
          $file = Get-ChildItem $setupOut -File | Where-Object { $_.Extension -eq '.exe' } | Select-Object -First 1
          if (-not $file) { Write-Error 'Installer .exe not found'; exit 1 }

          $name = $file.Name
          Write-Host "Uploading $($file.FullName) as $name to release $tag"

          $uri = "$upload_url?name=$name"
          Invoke-RestMethod -Method Post -Uri $uri -Headers @{Authorization = "token $token"; "Content-Type" = "application/octet-stream"} -InFile $file.FullName -Verbose
        shell: pwsh

      - name: Sanity list build artifacts
        run: |
          Get-ChildItem -Path ./parmigiano-desktop/bin/Release -Recurse | Select-Object FullName,Length
        shell: pwsh
